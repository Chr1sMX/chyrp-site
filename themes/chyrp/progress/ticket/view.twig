{% extends "layouts/progress.twig" %}

{% block content %}
<h1><a href="$ticket.milestone.url">$ticket.milestone.name</a> &raquo; $ticket.title $ticket.edit_link $ticket.delete_link</h1>
<p>$ticket.description</p>
{% if ticket.attachments %}
<p>
    <h5>Attachments</h5>
    <ul>
        {% for attachment in ticket.attachments %}
        <li>
            {% if attachment.info.extension == "jpg" or attachment.info.extension == "png" %}
            <img src="$site.chyrp_url/includes/thumb.php?file=../uploads/$attachment.path&amp;max_width=25" style="vertical-align: middle; border: 1px solid black" alt="attachment" />
            {% endif %}
            <a href="${ attachment.path | uploaded }">$attachment.filename</a>
        </li>
        {% endfor %}
    </ul>
</p>
{% endif %}
<br />
<h2>Revisions</h2>
<ul>
    {% paginate revision in 25 ticket.revisions as revisions %}
    <li id="revision_$revision.id">
        <strong>$revision.user.login</strong>:
        <ul>
            {% for name, change in revision.changes | items %}
            <li><strong>$name</strong> changed from "<code>$change.from</code>" to "<code>$change.to</code>"</li>
            {% endfor %}
        </ul>
        <p>$revision.body</p>
        {% if revision.attachments %}
        <p>
            <h5>Attachments</h5>
            <ul>
                {% for attachment in revision.attachments %}
                <li>
                    {% if attachment.info.extension == "jpg" or attachment.info.extension == "png" %}
                    <img src="$site.chyrp_url/includes/thumb.php?file=../uploads/$attachment.path&amp;max_width=25" style="vertical-align: middle; border: 1px solid black" alt="attachment" />
                    {% endif %}
                    <a href="${ attachment.path | uploaded }">$attachment.filename</a>
                </li>
                {% endfor %}
            </ul>
        </p>
        {% endif %}
        $revision.edit_link $revision.delete_link
    </li>
    {% else %}
    <li>(none)</li>
    {% endpaginate %}
</ul>

${ revisions.next_link }
${ revisions.prev_link }

<br />
<br />
{% if visitor.group.can("add_revision") %}
<h2>Revise Ticket</h2>
<form action="{% url "progress/add_revision" %}" method="post" accept-charset="utf-8" enctype="multipart/form-data">
    {% if ticket.editable %}
    <p>
        <label for="title">Ticket Title</label>
        <input type="text" name="title" value="${ ticket.title | escape }" id="title" />
    </p>
    {% endif %}

    <p>
        <label for="body">Message</label>
        <textarea name="body" rows="8" cols="100%"></textarea>
    </p>

    {% if ticket.editable %}
    <p>
        <label for="owner_id">Ticket Owner</label>
        <select name="owner_id" id="owner_id">
            <option value="0"></option>
            {% for user in users %}
            <option value="$user.id"${ user.id | option_selected(ticket.owner_id) }>${ (user.full_name | fallback(user.login)) | escape }</option>
            {% endfor %}
        </select>
    </p>
    <p>
        <label for="milestone_id">Ticket Milestone</label>
        <select name="milestone_id" id="milestone_id">
            <option value="0"></option>
            {% for milestone in milestones %}
            <option value="$milestone.id"${ milestone.id | option_selected(ticket.milestone_id) }>${ milestone.name | escape }</option>
            {% endfor %}
        </select>
    </p>
    <p>
        <label for="state">Ticket State</label>
        <select name="state" id="state">
            <option value="new"${ ticket.state | option_selected("new") }>new</option>
            <option value="open"${ ticket.state | option_selected("open") }>open</option>
            <option value="resolved"${ ticket.state | option_selected("resolved") }>resolved</option>
            <option value="invalid"${ ticket.state | option_selected("invalid") }>invalid</option>
            <option value="declined"${ ticket.state | option_selected("declined") }>declined</option>
        </select>
    </p>
    {% endif %}

    <p id="attachments">
        <label for="attachment">Attachment(s)</label>
        <input type="file" name="attachment[]" /> <a href="javascript:$$('#attachments').append('<br /><input type=\'file\' name=\'attachment[]\' />')">[+]</a>
    </p>

    <p><input type="submit" value="Continue &rarr;"></p>

    <input type="hidden" name="ticket_id" value="$ticket.id" id="ticket_id" />
</form>
{% endif %}
{% endblock %}
